<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Consent Manager — Cookie Migration Test</title>
  <style>body{font-family:Inter,Arial,sans-serif;padding:20px} .box{margin:12px 0;padding:10px;border:1px solid #ddd;border-radius:6px;background:#fafafa}</style>
</head>
<body>
  <h1>Consent Manager — Cookie Migration Test</h1>
  <p>This page helps you verify the new behaviour: the script clears old/invalid <code>consent_manager*</code> cookies before writing the new cookie.</p>

  <div class="box">
    <button id="set-old">Set legacy / malformed cookies</button>
    <button id="show">Show document.cookie</button>
    <button id="clear">Clear all consent_manager* cookies</button>
    <div id="output" style="margin-top:8px;white-space:pre-wrap;font-family:monospace"></div>
  </div>

  <div class="box">
    <button id="inline-set">Call: consentManagerInline.setCookieData(...)</button>
    <button id="frontend-save">Call: saveConsent('all') (frontend)</button>
    <div id="result" style="margin-top:8px;white-space:pre-wrap;font-family:monospace"></div>
  </div>

  <!-- Load the production scripts from the addon assets (relative) -->
  <script src="../js.cookie.min.js"></script>
  <script src="../consent_manager_frontend.js"></script>
  <script src="../consent_inline.js"></script>

  <script>
    function showCookies(el){ el.textContent = 'document.cookie:\n' + document.cookie; }

    document.getElementById('set-old').addEventListener('click', function(){
      // Create several legacy / malformed cookies to simulate old installations
      document.cookie = 'consent_manager=INVALID_PAYLOAD; path=/;';
      document.cookie = 'consent_manager_v2=some-old-format; path=/;';
      document.cookie = 'consent_manager_old=1; path=/;';
      showCookies(document.getElementById('output'));
    });

    document.getElementById('show').addEventListener('click', function(){
      showCookies(document.getElementById('output'));
    });

    document.getElementById('clear').addEventListener('click', function(){
      // try to remove any cookie starting with consent_manager
      var cookies = document.cookie.split('; ').map(function(c){ return c.split('=')[0]; });
      cookies.forEach(function(name){ if(name && name.indexOf('consent_manager') === 0){ document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/;'; }});
      showCookies(document.getElementById('output'));
    });

    document.getElementById('inline-set').addEventListener('click', function(){
      // Build a valid cookie payload and call inline api
      var payload = { consents: ['youtube'], version: 4, cachelogid: Date.now(), consentid: 'test-inline' };
      // setCookieData is defined on window.consentManagerInline
      window.consentManagerInline.setCookieData(payload);
      showCookies(document.getElementById('result'));
    });

    document.getElementById('frontend-save').addEventListener('click', function(){
      // Trigger standard frontend save — it now clears old cookies before writing
      try {
        saveConsent('all');
      } catch (e) {
        // saveConsent may rely on DOM elements; we simulate the cookie write directly as fallback
        try { deleteCookies(); } catch (e) {}
        var cookieData = { consents: ['youtube'], version: 9999, consentid: 'test-frontend', cachelogid: Date.now() };
        cmCookieAPI.set('consent_manager', JSON.stringify(cookieData));
      }
      showCookies(document.getElementById('result'));
    });

    // expose a small helper for manual testing
    window._show = function(){ showCookies(document.getElementById('output')); };
  </script>
</body>
</html>
