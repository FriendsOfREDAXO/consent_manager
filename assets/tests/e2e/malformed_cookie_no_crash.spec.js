const { test, expect } = require('@playwright/test');

test('malformed cookie or malformed event payload must not crash the page', async ({ page }) => {
  // keep track of page errors
  const errors = [];
  page.on('pageerror', (err) => errors.push(err.message));

  // Inject minimal global params before any page scripts run so the page
  // can't throw a "consent_manager_parameters is not defined" error.
  await page.addInitScript(() => {
    // minimal global params used by the static test fixture and scripts
    window.consent_manager_parameters = window.consent_manager_parameters || {
      version: '5',
      domain: window.location.hostname,
      consentid: 'test-consent',
      cachelogid: Date.now(),
      cookieSameSite: 'Lax',
      cookieSecure: false,
    };

    // these are referenced as globals in the built frontend (generated by PHP)
    // define them here as globals so the static test page doesn't blow up
    window.cmCookieExpires = 365;
    window.cmCookieSameSite = window.consent_manager_parameters.cookieSameSite || 'Lax';
    window.cmCookieSecure = window.consent_manager_parameters.cookieSecure || false;
    // minimal box template string referenced by the frontend
    // some frontend builds expect this to be a DOM node that can be appended
    if (!window.consent_manager_box_template) {
      // provide a minimal HTML string the frontend expects â€” must include
      // the root element with id 'consent_manager-background' so DOMParser
      // finds it and appendChild receives a valid Node.
      window.consent_manager_box_template = '<div id="consent_manager-background"><div id="consent_manager-box">' +
        '<div class="consent_manager-inner">Placeholder</div></div></div>';
    }
  });

  await page.goto('http://localhost:8000/assets/tests/consent_cookie_migration_test.html');

  // set a broken cookie
  await page.evaluate(() => {
    document.cookie = 'consent_manager=INVALID_PAYLOAD; path=/;';
  });

  // dispatch consent_manager-saved with a malformed detail string
  await page.evaluate(() => {
    document.dispatchEvent(new CustomEvent('consent_manager-saved', { detail: '}{ not json' }));
  });

  // give scripts a moment to execute
  await page.waitForTimeout(200);

  // dispatch consent_manager-saved with a non-string payload (Edge cases)
  await page.evaluate(() => {
    document.dispatchEvent(new CustomEvent('consent_manager-saved', { detail: null }));
  });

  await page.waitForTimeout(200);

  // Fail on any uncaught page errors
  expect(errors).toEqual([]);
});
