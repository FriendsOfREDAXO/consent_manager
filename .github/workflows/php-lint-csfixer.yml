name: PHP Lint & PHP-CS-Fixer

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  php-lint:
    name: test:php-cs - PHP lint & cs-fixer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Ensure full history and checkout of the PR/source ref so CI can commit & push fixes
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
          persist-credentials: true

      - name: Setup PHP
        # v2 is the published major release for shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml

      - name: Cache composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.json', '**/composer.lock') }}

      - name: Install composer dependencies
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php --quiet
          php -r "unlink('composer-setup.php');"
          php composer.phar install --no-interaction --prefer-dist --no-progress

      - name: PHP syntax check
        run: |
          set -e
          # exclude vendor
          find . -type f -name '*.php' -not -path './vendor/*' -print0 | xargs -0 -n1 php -l

      - name: Run PHP-CS-Fixer (auto-fix)
        env:
          GIT_AUTHOR_NAME: 'github-actions'
          GIT_AUTHOR_EMAIL: 'actions@github.com'
        run: |
          if [ -f ./vendor/bin/php-cs-fixer ]; then
            ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.php || true
            # if there are any changes, commit & push them back to the branch (auto-fix)
            if [ -n "$(git status --porcelain)" ]; then
              git config user.name "$GIT_AUTHOR_NAME"
              git config user.email "$GIT_AUTHOR_EMAIL"
              git add -A
              git commit -m "ci: php-cs-fixer auto-fixes (CI)" || echo "no changes to commit"
              # If running on a pull_request event the runner checks out a detached head â€” push to the PR's head ref
              if [ -n "${GITHUB_HEAD_REF}" ]; then
                git push origin "HEAD:${GITHUB_HEAD_REF}"
              else
                git push
              fi
            else
              echo 'No php-cs-fixer changes'
            fi
          else
            echo "php-cs-fixer not found in vendor; skipping"
          fi
